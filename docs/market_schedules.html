<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Market Hours Dashboard</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Day.js + plugins (UTC & timezone) -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>

  <style>
    :root{
      --uk-color:#6b9080; --us-color:#c94c4c; --hk-color:#4c72b0; --jp-color:#ff7f0e;
      --primary-accent:#8fbcb9;
      --neutral-bg:#f4f7f6; --neutral-text:#333;
      --panel-bg:#fff;     --panel-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --neutral-bg:#1e293b; --neutral-text:#f1f5f9;
        --panel-bg:#334155;   --panel-shadow:0 2px 5px rgba(0,0,0,.4);
        --uk-color:#8dd9c9; --us-color:#ff7366; --hk-color:#7aa2ff; --jp-color:#ffb454;
        --primary-accent:#38bdf8;
      }
      ::-webkit-scrollbar-thumb{background:#475569;border-radius:4px}
    }

    /* ---------- Layout ---------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Open Sans',sans-serif;
      background:var(--neutral-bg);
      color:var(--neutral-text);
      padding:20px;
    }
    header{text-align:center;margin-bottom:20px}
    header h1{color:var(--uk-color);margin-bottom:5px;font-size:1.8rem}
    .time-display{font-size:1.5rem;font-weight:600;margin-top:5px}

    .chart-container{
      background:var(--panel-bg);
      padding:20px;border-radius:8px;
      box-shadow:var(--panel-shadow);
      max-width:800px; margin:40px auto;
    }

    /* scrolling wrapper – stops the canvas being squished */
    .chart-scroll{overflow-x:auto;}

    /* give the canvas a built‑in ratio instead of a fixed height */
    .chart-scroll canvas{
      min-width:600px;
      width:100%!important;
      aspect-ratio:5/3;           /* NEW  – preserves shape */
      height:auto!important;      /* let browser compute */
    }

    /* ---------- Phone tweaks ---------- */
    @media (max-width:480px){
      body{padding:12px;}
      header h1{font-size:1.4rem}
      .time-display{font-size:1.2rem}
      .chart-container{padding:12px;margin:24px auto;}

      .chart-scroll canvas{
        min-width:500px;          /* still scrollable */
        aspect-ratio:5/3;         /* same ratio, taller as width grows */
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Global Market Hours</h1>
    <small>(Mon–Fri, non‑holiday)</small>
    <div id="local-time" class="time-display">--:-- --</div>
  </header>

  <section class="chart-container">
    <div class="chart-scroll">
      <canvas id="marketChart"></canvas>
    </div>
  </section>

  <script>
    /* 1  markets (unchanged) */
    const markets=[{label:'London',tz:'Europe/London',sessions:[['08:00','16:30']],colorVar:'--uk-color'},
      {label:'New York',tz:'America/New_York',sessions:[['09:30','16:00']],colorVar:'--us-color'},
      {label:'Hong Kong',tz:'Asia/Hong_Kong',sessions:[['09:30','12:00'],['13:00','16:00']],colorVar:'--hk-color'},
      {label:'Tokyo',tz:'Asia/Tokyo',sessions:[['09:00','15:00']],colorVar:'--jp-color'}];

    dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);
    const css=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
    let rowInfo=[];

    function buildSeries(){
      const now=dayjs(); const O=[],L=[],Lab=[],Col=[]; let maxEnd=0; rowInfo=[];
      markets.forEach(m=>m.sessions.forEach((s,i)=>{
        const [os,cs]=s, day=now.tz(m.tz).format('YYYY-MM-DD');
        let ou=dayjs.tz(`${day} ${os}`,m.tz).utc(), cu=dayjs.tz(`${day} ${cs}`,m.tz).utc();
        if(cu.isBefore(ou)) cu=cu.add(1,'day');
        const ol=ou.local(), cl=cu.local();
        let od=ol.hour()+ol.minute()/60, cd=cl.hour()+cl.minute()/60;
        if(cd<=od) cd+=24;
        O.push(od); L.push(cd-od); Lab.push(m.sessions.length===1?m.label:`${m.label} ${i?'PM':'AM'}`);
        Col.push(css(m.colorVar)); rowInfo.push({openLocal:ol,closeLocal:cl}); maxEnd=Math.max(maxEnd,cd);
      }));
      return{opens:O,lens:L,labels:Lab,colors:Col,maxEnd};
    }

    /* timeline plugin – mellow pulse */
    const timeLinePlugin={id:'timeLine',afterDraw:ch=>{
      const n=dayjs(), h=n.hour()+n.minute()/60+n.second()/3600;
      const x=ch.scales.x.getPixelForValue(h),{top,bottom}=ch.scales.y,ctx=ch.ctx;
      const a=css('--primary-accent'),gap=3,base=1.5;
      ctx.save();
      for(let y=top;y<=bottom;y+=gap){
        const phase=(Date.now()/1600+y*0.05)%Math.PI;
        const r=base+Math.sin(phase)*0.8;
        ctx.beginPath();ctx.arc(x,y,r,0,2*Math.PI);ctx.fillStyle=a;ctx.fill();
      }ctx.restore();
    }};

    /* chart init */
    const ctx=document.getElementById('marketChart').getContext('2d');
    const first=buildSeries(),tickColor=css('--neutral-text');
    const chart=new Chart(ctx,{type:'bar',
      data:{labels:first.labels,
        datasets:[
          {data:first.opens,backgroundColor:'transparent',stack:'grp'},
          {data:first.lens,backgroundColor:first.colors,borderColor:first.colors,borderWidth:1,
            borderRadius:6,borderSkipped:false,stack:'grp'}]},
      options:{responsive:true,maintainAspectRatio:true,indexAxis:'y',   /* ← back to true */
        scales:{
          x:{stacked:true,min:0,max:Math.max(24,Math.ceil(first.maxEnd/2)*2),
             ticks:{stepSize:2,callback:v=>`${v%24}:00`,color:tickColor}},
          y:{stacked:true,ticks:{color:tickColor}}},
        plugins:{legend:{display:false},
          tooltip:{callbacks:{label:({dataIndex:i})=>{
            const now=dayjs(),{openLocal:o,closeLocal:c}=rowInfo[i];
            if(now.isAfter(o)&&now.isBefore(c))return'Open for business';
            const m=(now.isBefore(o)?o:o.add(1,'day')).diff(now,'minute');
            return`Opens in ${Math.floor(m/60)}h ${m%60}m`;}}}}
      },plugins:[timeLinePlugin]});

    /* clock + refresh */
    function updateClock(){
      const now=new Date(),opt={hour:'numeric',minute:'2-digit',second:'2-digit',timeZoneName:'short'};
      document.getElementById('local-time').textContent=now.toLocaleTimeString([],opt);}
    function tick(){
      updateClock();
      const {opens,lens,labels,colors,maxEnd}=buildSeries();
      const now=dayjs(),curH=now.hour()+now.minute()/60,
            needMax=Math.max(24,Math.ceil(Math.max(maxEnd,curH)/2)*2);
      chart.data.labels=labels;
      chart.data.datasets[0].data=opens;
      chart.data.datasets[1].data=lens;
      chart.data.datasets[1].backgroundColor=colors;
      chart.data.datasets[1].borderColor=colors;
      chart.options.scales.x.max=needMax;
      const tc=css('--neutral-text');
      chart.options.scales.x.ticks.color=tc;chart.options.scales.y.ticks.color=tc;
      chart.update('none');
    }
    tick(); setInterval(tick,400);
  </script>
</body>
</html>